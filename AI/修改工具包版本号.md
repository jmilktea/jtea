在我们项目有一个工具包版本号的需求，工具包有如下这些，在同一个工程下，多模块的形式。

![image](https://github.com/jmilktea/jtea/blob/master/AI/images/tool-1.png)

业务项目会引用这些工具包进行开发，按照我们的开发规范，每个迭代开发阶段会定义一个SNAPSHOT的版本号，例如20250812.1-SNAPSHOT。  
当测试完成要上线前，测试会通过工具修改工具包的版本号，去掉-SNAPSHOT，deploy到nexus仓库，同时修改业务项目对应的引用版本号。

测试使用的工具是一个用java写好的.exe工具，它具有一下问题：

1.机器要装jvm，要装软件，要选环境，输账号密码。   
2.新人到需要安装，新加模块需要安装。   
3.有时候会修改失败，不好排查问题。   
4.可移植性不强，例如新环境要支持。   

过去一直想换一种方式实现，例如这种构建工作应该由jenkins来完成，无奈一些流水线语法，权限问题等阻碍。   
现在有了AI的加持，这个工作变得简单了，以下工作我甚至不需要写一行代码，全由AI完成。   
我们只需要描述清楚需求，并不断提示其优化即可，如下是生成后的流水线脚本。   

总结：
- 整个过程主要卡点在于权限问题和替换版本号，gpt给出了很多种方法读取pom文件，例如使用mvn命令，grovvy方法，正则等，但因为插件、权限等问题没能实现，最后它给出了用xmllint实现。
- 整个过程我用了gpt,cursor,gemini，从用户体验，流畅度和准确性来说，还是chatgpt更优，也可能是上下文完整性的问题。
- chatgpt甚至考虑到工具包之间相互引用这种问题，不过这个解决起来代码和参数变得复杂，且实际出现的情况很少，所以我没有用。
- 在与gpt对话过程中，需要提供比较精确的信息，例如依赖版本号是<version>1.0</version>还是<version>${version}</version>，这会产生完全不同的处理方式。

生成脚本如下：
```
pipeline {
    agent any
    parameters {
        extendedChoice(
            name: 'BUSINESS_PROJECTS',
            type: 'PT_MULTI_SELECT',
            description: '选择项目',
            multiSelectDelimiter: ',',
            value: 'server-A,server-B'
        )
        extendedChoice(
            name: 'TOOL_MODULES_TO_RELEASE',
            type: 'PT_MULTI_SELECT',
            description: '选择工具包',
            multiSelectDelimiter: ',',
            value: 'apollo-spring-boot-starter,db-spring-boot-starter'
        )
        string(
            name: 'BRANCH',
            description: 'release分支名',
            trim: true
        )
    }
    stages {
        stage('发布工具包') {
            steps {
                script {
                    if (!params.BRANCH?.trim()) error "BRANCH 参数不能为空"
                    if (params.BRANCH.trim().equalsIgnoreCase("master")) {
                        error "禁止直接在 master 分支上发布"
                    }

                    dir('tools') {
                        checkout([
                            $class: 'GitSCM',
                            branches: [[name: "*/${params.BRANCH}"]],
                            userRemoteConfigs: [[
                                url: 'git address',
                                credentialsId: 'your id' 
                            ]]
                        ])
                        
                        def changedModules = []
                        params.TOOL_MODULES_TO_RELEASE.tokenize(',').each { module ->
                            dir(module) {
                                def currentVersion = sh(
                                    script: "xmllint --xpath \"string(/*[local-name()='project']/*[local-name()='version'])\" pom.xml",
                                    returnStdout: true
                                ).trim()

                                if (currentVersion.endsWith("-SNAPSHOT")) {
                                    def releaseVersion = currentVersion.replace("-SNAPSHOT", "")
                                    echo "修改${module}版本号${currentVersion}为${releaseVersion}"
                                    sh "mvn versions:set -DnewVersion=${releaseVersion} -DgenerateBackupPoms=false"
                                    changedModules << module
                                }
                            }
                        }
                        
                        if (changedModules) {
                            echo "推送工具包到远端:${params.BRANCH}"
                            sh """
                                git config user.name "jenkins"
                                git config user.email "jenkins@company.com"
                                git checkout -B ${params.BRANCH}
                                git add ${changedModules.collect { "${it}/pom.xml" }.join(' ')}
                                git commit -m "update version: ${changedModules.join(', ')}"
                            """

                            withCredentials([sshUserPrivateKey(credentialsId: 'your id', keyFileVariable: 'GIT_SSH_KEY')]) {
                                sh """
                                    ssh-agent bash -c '
                                        ssh-add \$GIT_SSH_KEY
                                        git push origin ${params.BRANCH}
                                    '
                                """
                            }

                            changedModules.each { module ->
                                dir(module) {
                                    echo "deploy工具包到Nexus：${module}"
                                    sh "mvn clean deploy -DskipTests"
                                }
                            }
                        } else {
                            echo "没有工具包需要修改版本号"
                        }
                    }
                }
            }
        }
        stage('更新项目依赖') {
            steps {
                script {
                    def projects = params.BUSINESS_PROJECTS.tokenize(',')
                    def libsToRelease = params.TOOL_MODULES_TO_RELEASE.tokenize(',')

                    for (proj in projects) {
                        dir(proj) {
                            checkout([
                                $class: 'GitSCM',
                                branches: [[name: "*/${params.BRANCH}"]],
                                userRemoteConfigs: [[
                                    url: "git address",
                                    credentialsId: 'your id'
                                ]]
                            ])
                            
                            boolean changed = false

                            libsToRelease.each { lib ->
                                def currentVersion = sh(
                                    script: """
                                        xmllint --xpath "string(//*[local-name()='dependency'][*[local-name()='groupId']='com.*.*' and *[local-name()='artifactId']='${lib}']/*[local-name()='version'])" pom.xml
                                    """,
                                    returnStdout: true
                                ).trim()

                                if (!currentVersion) {
                                    echo "${proj}中没有找到工具包${lib}的依赖"
                                } else if (currentVersion.endsWith("-SNAPSHOT")) {
                                    def releaseVersion = currentVersion.replace("-SNAPSHOT", "")
                                    echo "修改${proj}中${lib}版本号${currentVersion}为${releaseVersion}"
                                    sh """
                                        mvn versions:use-dep-version \
                                            -Dincludes=com.*.*:${lib} \
                                            -DdepVersion=${releaseVersion} \
                                            -DforceVersion=true \
                                            -DgenerateBackupPoms=false
                                    """
                                    changed = true
                                }
                            }

                            if (changed) {
                                echo "推送项目到远端: ${proj}"
                                sh """
                                    git config user.name "jenkins"
                                    git config user.email "jenkins@company.com"
                                    git checkout -B ${params.BRANCH}
                                    git add pom.xml
                                    git commit -m "update tools dependencies"
                                """
                        
                                withCredentials([sshUserPrivateKey(credentialsId: 'your id',keyFileVariable: 'GIT_SSH_KEY')]) {
                                    sh """
                                        ssh-agent bash -c '
                                            ssh-add \$GIT_SSH_KEY
                                            git push origin ${params.BRANCH}
                                        '
                                    """
                                }
                            } else {
                                echo "项目${proj}没有依赖需要更新"
                            }
                        }
                    }
                }
            }
        }
    }
}
```
运行效果：

![image](https://github.com/jmilktea/jtea/blob/master/AI/images/tool-2-2.png)  
![image](https://github.com/jmilktea/jtea/blob/master/AI/images/tool-3.png)  
![image](https://github.com/jmilktea/jtea/blob/master/AI/images/tool-4.png)   

