## 前言
rm -rf file 是一个危险的命令，容易删库到跑路。但在测试环境或者一些生成环境，还是需要开发自己去维护，有时候会需要清理一些日志文件，释放磁盘空间。

本次遇到的问题起因是一个系统在启动的时候发生成报错，其中有一段骚代码会while(true)不断的打印日志，结果瞬间就把磁盘空间占用到95%左右，服务器告警。  
没告警前还没考虑到磁盘空间的问题，只是觉得这些日志没有用了，影响正常的错误日志，就使用rm命令对其进行删除。  
结果就是后面的服务器还在告警，运维反应是磁盘空间没有释放，问题引出。

## 问题原因
原因很简单，删除日志文件的时候，应用进程还在运行，也就是文件还被引用，此时使用rm命令删除，在linux下，文件删了，但磁盘空间不会释放。
在windows下，通常会提示：文件正在使用，无法删除

我们可以简单的复现这个问题
1. df -h 查看当前磁盘空间，可以看到/目录已用7.6G  
![image](https://github.com/jmilktea/jtea/blob/master/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/images/rm-1.png)  
2. 使用 dd if=/dev/zero of=file bs=1M count=1000 命令，创建一个1G的大文件，在使用1查看，可以看到已用8.6G  
![image](https://github.com/jmilktea/jtea/blob/master/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/images/rm-2.png)  
3. 打开一个新的会话，使用 less file 查看该文件，此时 ps -ef | grep less 可以看到有一个进程正在查看文件  
![image](https://github.com/jmilktea/jtea/blob/master/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/images/rm-3.png)  
4. 使用rm file删除文件，ls 看到文件已经不存在了，此时用1查看空间，可以看到空间没有释放

## 解决方案
1. 由上面的问题原因可以知道，是有进程在引用文件，可以把这个进程停止即可，如上我们把less进程停掉，可以看到1G空间就释放了  
2. 如果进程正在对外提供服务，不能停止，可以使用重定向的方式，清空文件，命令为：> file

## 思考  
那么如果是误删，如何找回文件呢？  
我们知道文件还没进程引用着，那么linux肯定还把它藏在某个地方，我们可以通过如下方式找回   
1. 找到还引用这被delete文件的进程pid
```
lsof | grep 文件名
```
2. 找到文件  
```
cd /proc/pid/fd/
```
3. 恢复文件  
```
cp 4 /root/revertFile
```
