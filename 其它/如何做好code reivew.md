- review 目的   
随着项目不断迭代发展，新同学不断加入，如果没有对代码进行审查，质量把关，最终就会越来越乱，代码越来越难以维护，后期迭代修改变得困难，bug增多。   
所以code review的最主要目的就是把控代码质量，把问题扼杀在萌芽阶段，保证项目可持续发展。    
此外，review可以相互熟悉需求，我们都有可能去接收别人的代码，如果一点都不知道背景，那么每次接手都会很痛苦，review过程我们可以熟悉别人做的需求，后续有相关需求上手相对就会容易一些。   
同时，review也是个交流、自我展示的机会，对于看到一些别人代码不对、不好的地方，我们可以友善指出，帮助提早发现问题，优化代码。对于一些自己写得好的地方，可以分享给大家，共同学习。   
开发都喜欢 talk is cheap show me the code，直接展示代码比口头说要容易明白很多。   

![image](1)  

- review 时间  
通常在周五下午review下一个星期要上线的需求。  
如果有更往后迭代的需求已经开发完成，会上如果有时间，可以主动提出来review。   
如果需求是在周一后才完成，本周四就上线了，赶不上review的，那么应该单独申请时间review，或者找leader单独review。   
准时参见会议，有事情处理的需要说明，不要出现一群人等一两个人的情况。   

- review 内容   
1.技术方案，虽然技术方案开发前我们已经过一遍，但在review的时候依然要给大家讲一下实现思路，让大家在看你代码前有个印象。   
2.代码修改，配置，脚本，定时任务，缓存等，是重点。每个模块，每行代码修改、配置都应该过一遍，下面我们还会细说。   
3.上线方案，说清楚需求怎么上线，有没有脚本，有没有关联方依赖，有没有数据需要初始化，有没有网络需要打通等等。   

对code review有个大概了解后，我们看下怎么做这件事。review会议的时间不会很长，我们需要在有限的时间内把做的东西讲清楚，知易行难，虽然我们已经进行过多次code review，但仍有进步空间。例如有时候会出现如下问题：

- 需求比较久了，中途比较忙，这个需求已经不太记得了，在会上说起来断断续续。  
- 开发代码忘记推送了，回座位推送代码，大家都在等。
- 忘记改哪些代码了，想了一会才想起来。
- 上次出现的问题，这次又出现了。
- 出现一些违法简单约定俗成的规范，如变量命名、未判空、代码格式化等。
# 如何review 
![image](2)  

按照review时间，分为review前 → review中 → review后 3个环节，每个环节我们应该做什么，关注什么。

# review前  
- 熟悉需求  
例如周五下午会议，那么在上午可以抽些时间回顾一下做过的内容，参与review的同学也要先熟悉相关需求。   
有些需求可能比较复杂，改的内容或者模块很多，如果没有一点准备讲和听起来都不容易。   
被review的同学讲得不通顺，整个过程断断续续，难以理解。参与review的同学不熟悉需求，无法发现问题，提出建设性建议。   

- 组织好语言  
怎么去表达需求，代码，表达要流畅，通顺，在会上发言也是一种锻炼。记得开始时我们很多同学在review过程表达都不是很好，现在都有所进步了。   

- 组织好顺序  
有时候改动比较多，需要按顺序讲解，否则就像无头苍蝇，整个过程很乱。你可以先划分好模块，按照业务流程顺序讲就会比较清晰。

- 提前想好问题  
有些代码可能需要兼容老的逻辑或数据，或者出于性能考虑，写法不是那么简单直接。可以提前预猜大家可能会对这段代码有疑问，提前准备好怎么解释。   
避免在会上被人家这么简单一问，自己也回忆不起来，或者否定自己的做法。   
例如有个需求需要判断时间差不要超过30天，开发同学通过api调试后最终写法是 f(time1) - f(time2) > 29，明显大家会有疑问这里为什么是29而不是需求里的30。

- 提前自我review  
没有人能一次就写出好的代码，好的代码都是迭代出来的。有些同学习惯写完没问题就当做完成，缺少一个自我review的过程，自我检查可以查漏补缺，帮助优化代码，避免被review出问题过多。

# review中
**以下内容既是被review同学需要重点提及和展示的内容，也是参与review同学重点关注的内容。**

**数据库变更**  
这是重点，数据库的改动往往不好迭代修改，例如取了一个不好的字段名称，后面要平滑、不停机修改它就非常困难，所以这一块review过程要重点介绍。

- 新加表   
表的作用，表命名是否符合规范

- 字段设计是否合理   
包括字段命名，类型，长度，备注，是否为空等。   
例如我们出现过给字段设置了null，但生成有代码用int接收导致空指针。   
例如我们出现过给字段设置了编码，结果编码和关联表字段的编码不一样，导致报错。   

- 添加索引是否合理

- 表是否符合sql平台规范  
我们出现过几次上线过程发现脚本不符合规范的问题，影响上线流程，建议后面建好表后，拿到sql平台校验一下。

- 脚本上线是否平滑  
例如新增一个not null没有default的字段，先更新脚本，服务没更新，插入就都会报错。

- 处理数据的脚本是否合理  
例如是否一次性处理过多数据，一次性插入过多数据dba是不允许的，会占用大量资源，造成主从延迟影响业务。一般数据过多要分次处理，例如每次1W，或者通过写代码跑。

**其它中间件变更**
- mq  
发送哪些内容，例如之前出现过因为mq内容发送过多，超过kafka最大消息大小，导致报错。   
流量有多大，是否需要更多的partition或线程消费。   
消费是否幂等，消息是否有序。   

- 缓存  
使用了什么数据类型，数据量存储级别是否合理。   
例如我们出现过redis存储过多无用数据导致带宽占满，影响缓存。   

- 定时任务  
是否有依赖，依赖是否正确。   
定时任务是否需要支持优雅中断，不影响发版。

**代码变更**
- 新加了哪些接口  
接口url，出入参数，是否有检验参数，是否有检验权限。

- 新加了哪些配置  
为什么加这个配置，配置加的模块是否合理，配置的上线是否有兼容问题。   
例如我们出现过改了配置的key，配置修改后，服务还没起来，导致报错。

- 新加了哪些通用工具类，方法  
一些通用的接口，工具类要介绍出来让大家知道。   
例如A同学本次新增了DateUtil，下次同学B新增了DateTimeUtil，有重点说明别人就能记住。

- 是否已经存在相同功能代码  
有时候可能对系统或某些模块不熟，不知道已经有相同实现。   
例如新加一个接口或类，系统已经存在相同功能代码，可以不需要加。   

- sql  
本次有新增、修改到的每条sql都要过，看sql是否合理。   
例如我们出现过开发同学写了一条sql查大表没有走索引，严重影响数据库性能。

- 关注边界问题  
现在我们都会写单元测试和联调，一般问题都能提前处理掉。   
但边界问题往往容易忽略，例如循环退出条件，参数边界有没有校验，边界往往最容易出现bug。   
我们曾经出现过while循环没有正确退出，导致服务挂掉的情况。

- 对接外部接口  
接口是否有打印出入参，是否需要提前开通过网络，是否需要接入告警。

- 日志打印  
日志打印是否合理，是否应加或不应加，是否有打印关键参数。

- 代码注释  
随着业务代码越来越复杂，需要合理注释，方便后续维护。   
例如写了一个分案算法，需要注释，或者文档链接。

- 修改，删除代码  
修改了哪些代码，接口，接口修改能不能兼容老版本。   
删除了哪些代码，为什么删除，删除能不能支持老版本。   
特别的app的相关接口，有些用户不愿升级，通常需要兼容老版本。

# review后
- 代码修改  
修改如果比较多，需要重新让leader再次review，避免没修改对或出现新的问题。

- 自我总结  
自己出现的问题下次不再出现，别人出现的问题也要警惕自己。

- 纳入开发规范  
一些通用问题可以写入开发规范，后来人可以避免重复犯错。

# 其它
- 友好提问
我们要求review的过程是严格的，严格有助于代码改进。   
但沟通方式应该是友好的，避免过激烈争论。

- 灰色问题
有些情况没有绝对对错，可以讨论一下，最终取一个相互认同的做法。   
规范没有最好，只要被团队大多数人认可即可。   
在一些相互争论各自有理的情况下，可以以leader的意见为准。

- 控制时间
我们review的时间经常超时，甚至有的需求超过2小时，要控制好时间。   
例如只讲你修改的地方，一些没动到的地方，不讲或简单带过。

- 亮点介绍
review过程也是个自我展示的过程，有好的想法，好的代码，工具，可以分享给大家。   
对于一些好的设计，代码，思路我们要给予肯定，鼓励大家学习。

- 开发规范
我们把review出来可以作为规范的写入团队开发规范，其他同学或新加入同学可以学习。




